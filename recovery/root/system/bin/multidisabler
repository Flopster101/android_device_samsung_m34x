#!/system/bin/sh
#
# A simple Samsung services disabler by Ian Macdonald.
#
# Use this to prime your device after installing TWRP.

patch_block() {
    echo " - Disabling encryption and recovery restoration..."
    bxhsed --quiet $1 '/vendor/recovery-from-boot.p|/vendor/recovery-from-bsod.p' 'fileencryption=|notencryptable='
    ret=$?
    if [ "$ret" -gt "0" ]; then
        echo " -    Success... (${ret})"
    elif [ "$ret" -eq "0" ]; then
        echo " -    Already disabled..."
    else
        echo " -    Failed! (exit code: ${ret})"
    fi
}

fsck() {
    fsck.f2fs -f -y $1
    if [ "$?" != "0" ]; then
        echo " - Error: Failed to run fsck!"
    fi
}

umount_vendor() {
  echo " - Unmounting /vendor"
  if mount | grep -q /vendor; then
    umount /vendor &>/dev/null
    if mount | grep -q /vendor; then
      echo " -   Unmount failed. Aborting..."
      return 1
    fi
  fi
}

mount_vendor() {
  echo " - Mounting /vendor"
  if ! mount | grep -q /vendor; then
    mount -o ro /vendor &>/dev/null
    if ! mount | grep -q /vendor; then
      echo " -   Mount failed. Aborting..."
      return 1
    fi
  fi
}

echo " "
echo "Multi-disabler for Samsung devices"
echo "running ReadOnly F2FS Vendor Images."
echo " "

os=$(getprop ro.build.version.release)
major=${os%%.*}
bl=$(getprop ro.boot.bootloader)
dp=$(getprop ro.boot.dynamic_partitions)

# Firmware version starts at either 8th or 9th character, depending on length
# of bootloader string (12 or 13).
#
fw=${bl:$((${#bl} - 4)):4}
bn=${bl:$((${#bl} - 6)):2}

# Device is first 5 characters of bootloader string.
#
device=${bl:0:$((${#bl} - 8))}
mft=$(getprop ro.product.manufacturer | tr '[A-Z]' '[a-z]')

if [ "$mft" != samsung ]; then
  echo " - Device appears not to be made by Samsung."
  fatal=true
elif [ -z "$device" ]; then
  echo " - Could not determine device model."
  fatal=true
elif [ $major -lt 9 ]; then
  echo " - This software is incompatible with Android $major."
  fatal=true
fi
if [ -n "$fatal" ]; then
  echo " - Installation aborted."
  echo " "
  exit 1
fi

echo " - Detected a SM-${device} device with a ${fw} (${bn}) bootloader."
echo " - The environment appears to be Android ${major}"
echo " "

umount_vendor || exit 1
lptools unmap vendor
lptools map vendor
mount_vendor || exit 1

dm_block=$(df -t f2fs | grep "/vendor" | cut -DF1)
if [ "$dm_block" == "" ]; then
  echo " - Error: Could not determine vendor block..."
  exit 1
fi
echo " - Detected vendor at ${dm_block}"

if grep -qs "/vendor/recovery-from-boot.p" /vendor/bin/install-recovery.sh || grep -qs "fileencryption=" /vendor/etc/fstab.*; then
  run=true
fi

umount_vendor || exit 1

if [ "$run" == "true" ]; then
  patch_block $dm_block
  fsck $dm_block
else
  echo " - Nothing to do!"
fi

echo " "
echo " - Finished."
echo " "
